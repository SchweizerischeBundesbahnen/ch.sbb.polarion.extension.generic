---
name: Build & Release
on:
  push:
    branches: ['**']
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:
env:
  SETTINGS_XML: ${{ github.workspace }}/.mvn/settings.xml
  JAVA_VERSION: 17
  JAVA_DISTRIBUTION: temurin
jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
    outputs:
      project_version: ${{ steps.project_metadata.outputs.version }}
      is_release: ${{ steps.project_metadata.outputs.is_release }}
    env:
      IO_JFROG_SBB_POLARION_TOKEN: ${{ secrets.IO_JFROG_SBB_POLARION_TOKEN }}
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      MARKDOWN2HTML_MAVEN_PLUGIN_FAIL_ON_ERROR: true
    steps:
      - name: üìÑ Checkout the repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1
        with:
          fetch-depth: 0  # Sonar needs full history
          persist-credentials: false
      - name: üß± Set up JDK and Maven
        uses: actions/setup-java@dded0888837ed1f317902acf8a20df0ad188d165  # v5.0.0
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}
          cache: maven
      - name: üìù Extract project metadata
        id: project_metadata
        run: |
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          # Check if it is a release
          if [[ ! "${VERSION}" =~ -SNAPSHOT$ ]]; then
            IS_RELEASE=true
          else
            IS_RELEASE=false
          fi
          {
            echo "version=${VERSION}"
            echo "is_release=${IS_RELEASE}"
          } >> "$GITHUB_OUTPUT"
      - name: üîç Cache SonarQube packages
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830  # v4.3.0
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar
      - name: üì¶ Build with Maven for Pushes
        if: github.event_name == 'push'
        env:
          GITHUB_HEAD_REF: ${{ github.head_ref }}
          COM_SONATYPE_CENTRAL_POLARION_OPENSOURCE_GPG_PASSPHRASE: ${{ secrets.COM_SONATYPE_CENTRAL_POLARION_OPENSOURCE_GPG_PASSPHRASE }}
        run: |
          if [ -n "${GITHUB_HEAD_REF}" ]; then
            mvn --batch-mode -s "${SETTINGS_XML}" clean verify sonar:sonar -Dsonar.branch.name="${GITHUB_HEAD_REF}"
          else
            mvn --batch-mode -s "${SETTINGS_XML}" clean verify sonar:sonar
          fi
      - name: üì¶ Build with Maven for PRs
        if: github.event_name == 'pull_request'
        env:
          GITHUB_HEAD_REF: ${{ github.head_ref }}
          GITHUB_BASE_REF: ${{ github.base_ref }}
          GITHUB_PR_NUMBER_REF: ${{ github.event.pull_request.number }}
        run: mvn --batch-mode -s "${SETTINGS_XML}" clean verify sonar:sonar -Dsonar.pullrequest.base="${GITHUB_BASE_REF}" -Dsonar.pullrequest.branch="${GITHUB_HEAD_REF}" -Dsonar.pullrequest.key="${GITHUB_PR_NUMBER_REF}"
      - name: üìã Analyze dependencies
        run: mvn --batch-mode -s "${SETTINGS_XML}" dependency:analyze
        continue-on-error: false
      - name: üì¶ Upload build artifacts
        # needed for uploads to GitHub Releases
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4  # v5.0.0
        with:
          name: maven-artifacts
          path: |
            app/target/*.jar
            app/target/*.pom
          retention-days: 1
          if-no-files-found: error
  deploy-maven-central:
    needs: build
    if: ${{ needs.build.outputs.is_release == 'true' && github.ref == 'refs/heads/main' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
    env:
      COM_SONATYPE_CENTRAL_POLARION_OPENSOURCE_USERNAME: ${{ secrets.COM_SONATYPE_CENTRAL_POLARION_OPENSOURCE_USERNAME }}
      COM_SONATYPE_CENTRAL_POLARION_OPENSOURCE_TOKEN: ${{ secrets.COM_SONATYPE_CENTRAL_POLARION_OPENSOURCE_TOKEN }}
      COM_SONATYPE_CENTRAL_POLARION_OPENSOURCE_GPG_PASSPHRASE: ${{ secrets.COM_SONATYPE_CENTRAL_POLARION_OPENSOURCE_GPG_PASSPHRASE }}
    steps:
      - name: üìÑ Checkout the repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1
        with:
          fetch-depth: 1
          persist-credentials: false
      - name: üß± Set up JDK and Maven with cache
        uses: actions/setup-java@dded0888837ed1f317902acf8a20df0ad188d165  # v5.0.0
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}
          cache: maven
          gpg-private-key: ${{ secrets.COM_SONATYPE_CENTRAL_POLARION_OPENSOURCE_GPG_PRIVATE_KEY }}
      - name: üì¶ Deploy to Maven Central
        run: |
          # it cannot be implemented using deploy:deploy-file
          # central-publishing-maven-plugin needs to be used instead due to a specific deployment
          mvn --batch-mode -s "${SETTINGS_XML}" clean deploy \
            -P gpg-sign \
            -P central-publishing \
            -Dcentral.timeout=3600
  deploy-github-packages:
    needs: build
    if: ${{ github.ref == 'refs/heads/main' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    env:
      GITHUB_TOKEN: ${{ github.token }}
      GITHUB_REPO_NAME: ${{ github.repository }}
      PROJECT_VERSION: ${{ needs.build.outputs.project_version }}
    steps:
      - name: üìÑ Checkout the repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1
        with:
          fetch-depth: 1
          persist-credentials: false
      - name: üì• Download build artifacts
        # needed for uploads to GitHub Releases
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53  # v6.0.0
        with:
          name: maven-artifacts
          path: app/target/
      # Releases and snapshots do not need to be deployed to GitHub packages
      - name: üì¶ Upload assets to GitHub Release
        if: ${{ needs.build.outputs.is_release == 'true' }}
        run: |-
          gh release upload "v${PROJECT_VERSION}" "app/target/*-${PROJECT_VERSION}.jar" --clobber
          gh release upload "v${PROJECT_VERSION}" "app/target/*-${PROJECT_VERSION}-tests.jar" --clobber
